---
# Ollama installation and service configuration
# Idempotent: safe to re-run; detects existing installation

- name: "Check if Ollama is already installed"
  ansible.builtin.stat:
    path: "{{ homebrew_prefix }}/bin/ollama"
  register: ollama_bin
  when: ansible_system == "Darwin"

- name: "Get installed Ollama version (if present)"
  ansible.builtin.command: "{{ homebrew_prefix }}/bin/ollama --version"
  register: ollama_current_version
  failed_when: false
  changed_when: false
  when:
    - ansible_system == "Darwin"
    - ollama_bin.stat.exists

- name: "Display current Ollama version"
  ansible.builtin.debug:
    msg: "Ollama currently installed: {{ ollama_current_version.stdout }}"
  when:
    - ansible_system == "Darwin"
    - ollama_bin.stat.exists
    - ollama_current_version is defined
    - ollama_current_version is not skipped
    - ollama_current_version.stdout is defined

- name: "Install Ollama via Homebrew"
  community.general.homebrew:
    name: ollama
    state: present
  when:
    - ansible_system == "Darwin"
    - not ollama_bin.stat.exists

- name: "Upgrade Ollama (if upgrades enabled)"
  ansible.builtin.command: "{{ homebrew_prefix }}/bin/brew upgrade ollama"
  when:
    - ansible_system == "Darwin"
    - ollama_upgrade | bool
    - ollama_bin.stat.exists
  register: ollama_upgrade_result
  changed_when: "'ollama' in ollama_upgrade_result.stdout"
  failed_when: ollama_upgrade_result.rc != 0 and 'already installed' not in ollama_upgrade_result.stderr

- name: "Verify Ollama installation"
  ansible.builtin.command: "{{ homebrew_prefix }}/bin/ollama --version"
  register: ollama_version_output
  changed_when: false
  when: ansible_system == "Darwin"

- name: "Display Ollama version"
  ansible.builtin.debug:
    msg: "Ollama version: {{ ollama_version_output.stdout }}"
  when:
    - ansible_system == "Darwin"
    - ollama_version_output is defined
    - ollama_version_output is not skipped
    - ollama_version_output.stdout is defined

- name: "Ensure LaunchAgents directory exists"
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/Library/LaunchAgents"
    state: directory
    mode: "0755"
  when: ansible_system == "Darwin"

- name: "Configure Ollama launchd plist (bind address)"
  ansible.builtin.template:
    src: homebrew.mxcl.ollama.plist.j2
    dest: "{{ ansible_env.HOME }}/Library/LaunchAgents/homebrew.mxcl.ollama.plist"
    mode: "0644"
  notify: "Restart Ollama service"
  when: ansible_system == "Darwin"

- name: "Check if Ollama launchd service is loaded"
  ansible.builtin.command: "launchctl list homebrew.mxcl.ollama"
  register: ollama_svc_check
  changed_when: false
  failed_when: false
  when: ansible_system == "Darwin"

- name: "Load Ollama launchd service if not already running"
  ansible.builtin.command: >-
    launchctl load -w
    {{ ansible_env.HOME }}/Library/LaunchAgents/homebrew.mxcl.ollama.plist
  when:
    - ansible_system == "Darwin"
    - ollama_svc_check.rc != 0
  changed_when: true

- name: "Wait for Ollama API to be available"
  ansible.builtin.uri:
    url: "http://{{ ollama_api_host }}:{{ ollama_api_port }}/api/tags"
    method: GET
    timeout: 5
    status_code: 200
  register: ollama_health
  until: ollama_health.status == 200
  retries: 6
  delay: 5
  when: ansible_system == "Darwin"
  failed_when: false

- name: "Display Ollama health check result"
  ansible.builtin.debug:
    msg: "Ollama API is {{ 'healthy' if ollama_health.status == 200 else 'not responding' }}"
  when:
    - ansible_system == "Darwin"
    - ollama_health is defined
    - ollama_health is not skipped

- name: "Verify Ollama is listening on all interfaces"
  ansible.builtin.command: "lsof -nP -iTCP:{{ ollama_api_port }} -sTCP:LISTEN"
  register: ollama_listen_check
  changed_when: false
  failed_when: false
  when: ansible_system == "Darwin"

- name: "Assert Ollama is bound to 0.0.0.0:{{ ollama_api_port }}"
  ansible.builtin.assert:
    that:
      - ollama_listen_check.rc == 0
      - "'*:' + (ollama_api_port | string) in ollama_listen_check.stdout"
    fail_msg: >-
      Ollama is not listening on all interfaces (0.0.0.0:{{ ollama_api_port }}).
      Check {{ ansible_env.HOME }}/Library/LaunchAgents/homebrew.mxcl.ollama.plist
      and confirm OLLAMA_HOST={{ ollama_host_bind }}:{{ ollama_api_port }} is set.
      lsof output: {{ ollama_listen_check.stdout | default('(empty)') }}
    success_msg: "Ollama is bound to 0.0.0.0:{{ ollama_api_port }} (reachable over Tailscale)"
  when: ansible_system == "Darwin"
